name: Build and Analyse Notification Service

on:
  push:
    branches:
      - features/workflows

env: 
   MAIL_PASSWORD: ${{ secrets.MAILPASSWORD }}

jobs: 
    generate-notif:
      name: generate notification service and build docker image
      runs-on: ubuntu-latest
      
      steps:
        # step 1: checkout the code
        - name: Checkout code
          uses: actions/checkout@v3

        # step 2: Set up Python
        - name: Set up Python
          uses: actions/setup-python@v2
          with:
            python-version: '3.x'
        
        # step 3: Install dependencies
        - name: Install Python dependencies
          run: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt

        - name: Lint with flake8
          run: |
            flake8 .

        # step 4: Generate notification service for Python using Anchore's action
        - name: Generate SBOM for Python
          uses: anchore/sbom-action@v0
          with:
            format: json
            artifact-name: sbom-python.json
          
        # step 5: Build Docker image
    Trivy:
      permissions:
        contents: read # for actions/checkout to fetch code
        security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
        actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
      name: Trivy
      runs-on: "ubuntu-20.04"
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
    
        - name: Build an image from Dockerfile
          run: |
            docker build -t docker.io/maggeggivr/notification-service:${{ github.sha }} .
    
        - name: Run Trivy vulnerability scanner
          uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
          with:
            image-ref: 'docker.io/maggeggivr/notification-service:${{ github.sha }}'
            format: 'template'
            template: '@/contrib/sarif.tpl'
            output: 'trivy-results.sarif'
            severity: 'CRITICAL,HIGH'
    
        - name: Upload Trivy scan results to GitHub Security tab
          uses: github/codeql-action/upload-sarif@v3
          with:
            sarif_file: 'trivy-results.sarif'

        # step 6: Generate SBOM for Docker image using Anchore's SBOM Action
        - name: Generate SBOM for Docker image
          uses: anchore/sbom-action@v0
          with:
            image: my-python-app:latest
            format: json
            artifact-name: sbom-docker-image.json

    sonarcloud:
      name: SonarCloud
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
          with:
            fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
        - name: SonarCloud Scan
          uses: SonarSource/sonarcloud-github-action@master
          env:
            GITHUB_TOKEN: ${{ secrets.GTB_TOKEN }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}